# yaml-language-server: $schema=
# Re-queued tasks from phase20 that were interrupted
tasks:
  - name: edge-case-small-matrices
    prompt: |
      Add boundary testing for small matrix dimensions in Metal Marlin.

      Create `tests/test_edge_cases.py` with tests for:
      1. M=1 (single token inference)
      2. N=1 (single output feature)
      3. K < group_size (partial groups)
      4. M < tile size (partial tiles)
      5. Dimensions not divisible by 8/16/32

      Test all kernel variants: FP4, INT4, FP8.
      Verify output correctness against NumPy reference.

      Working directory: contrib/iq-vs-k-bench/metal_marlin/
    priority: P1
    dependencies: []

  - name: u4-scale-shape-consistency
    prompt: |
      Audit and fix INT4 (u4) scale tensor shape handling in Metal Marlin.

      Review these files for shape consistency:
      - metal_marlin/quantize.py (pack_u4_weights, unpack_u4_weights)
      - metal_marlin/kernels.py (marlin_gemm_u4, marlin_gemm_fused_u4)
      - src/marlin_gemm.metal (u4 dequant kernel)

      Ensure:
      1. Scale shape is [K // group_size, N] consistently
      2. Zero-point shape matches scale shape
      3. Group size boundary handling is correct
      4. Add assertions/validation in Python code

      Working directory: contrib/iq-vs-k-bench/metal_marlin/
    priority: P1
    dependencies: []

  - name: bf16-kernels-migration
    prompt: |
      Migrate hardcoded FP16 to use DTypeConfig in Metal Marlin kernels.py.

      Current state: 15 instances of mx.float16 hardcoded in kernels.py
      Target: Use DTypeConfig.compute_dtype from dtypes.py

      Changes needed:
      1. Import DTypeConfig from dtypes.py
      2. Replace mx.float16 with config.compute_dtype
      3. Add dtype parameter to public functions with default=None (auto-detect)
      4. Preserve backward compatibility

      Reference dtypes.py for DTypeConfig pattern.
      Run tests after changes: pytest tests/test_kernels.py -v

      Working directory: contrib/iq-vs-k-bench/metal_marlin/
    priority: P1
    dependencies: []

  - name: edge-case-m-equals-1
    prompt: |
      Fix and test M=1 (single token) edge case in Metal Marlin GEMM kernels.

      M=1 is critical for autoregressive inference. Issues to check:
      1. Tile boundary handling when M < tile_M
      2. Accumulator initialization for partial tiles
      3. Output write bounds checking

      Files to review:
      - src/marlin_gemm.metal (all kernel variants)
      - metal_marlin/kernels.py (dispatch logic)

      Add specific M=1 test cases to tests/test_edge_cases.py.
      Verify against NumPy reference for correctness.

      Working directory: contrib/iq-vs-k-bench/metal_marlin/
    priority: P1
    dependencies:
      - edge-case-small-matrices

  - name: u4-dequant-formula-audit
    prompt: |
      Audit INT4 (u4) dequantization formula for correctness in Metal Marlin.

      The magic-bias dequant should be:
      1. Unsigned INT4: value in [0, 15]
      2. Symmetric: output = (value - 8) * scale
      3. Asymmetric: output = (value - zero_point) * scale

      Review and document:
      - src/dequant.metal: dequant_u4_magic function
      - src/marlin_gemm.metal: inline u4 dequant
      - metal_marlin/quantize.py: pack_u4_weights quantization formula

      Ensure Python pack and Metal unpack are inverses.
      Add detailed comments explaining the formula.

      Working directory: contrib/iq-vs-k-bench/metal_marlin/
    priority: P1
    dependencies:
      - u4-scale-shape-consistency
