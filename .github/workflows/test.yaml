---
name: Trellis Tests

"on":
  push:
    paths:
      - 'contrib/metal_marlin/**'
  pull_request:
    paths:
      - 'contrib/metal_marlin/**'

jobs:
  test-trellis:
    runs-on: macos-14  # M1/M2 runner with MPS

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        working-directory: contrib/metal_marlin
        run: uv sync --extra all

      - name: Run trellis unit tests
        working-directory: contrib/metal_marlin
        run: |
          uv run pytest tests/test_trellis*.py -v --tb=short \
            --ignore=tests/test_e2e_trellis.py \
            -m "not slow"

      - name: Check imports
        working-directory: contrib/metal_marlin
        run: |
          uv run python -c "
          from metal_marlin.trellis_loader import TrellisModelLoader
          from metal_marlin.trellis_linear import TrellisLinear
          from metal_marlin.trellis_dispatch import dispatch_trellis_dequant
          print('All trellis imports successful')
          "

  test-with-model:
    runs-on: macos-14
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        working-directory: contrib/metal_marlin
        run: uv sync --extra all

      - name: Download test model (small)
        working-directory: contrib/metal_marlin
        run: |
          # Download a small EXL3 model for testing
          # (This would need to be set up with an actual small model)
          echo "Skipping model download for now"

      - name: Run e2e tests
        working-directory: contrib/metal_marlin
        run: |
          if [ -d "models/test-model" ]; then
            uv run pytest tests/test_e2e_trellis.py -v --tb=short
          else
            echo "Test model not available, skipping e2e tests"
          fi
